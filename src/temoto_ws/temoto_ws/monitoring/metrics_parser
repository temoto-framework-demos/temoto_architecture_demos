#!/bin/bash

NR_OF_CPUS=$(nproc)
if [[ -z "${TEMOTO_NAMESPACE}" ]]; then
  DATA_PREFIX=''
else
  DATA_PREFIX=${TEMOTO_NAMESPACE}
fi

while sleep 1
do 
    z=$(ps aux)
    while read -r line
    do
        var_cpu=$var_cpu$(awk -v var1=$DATA_PREFIX var2=$NR_OF_CPUS'{print "cpu_usage{process=\""var1"_"$11"\", pid=\""$2"\"}", $3/var2 line}')
    done <<< "$z"

    echo $var_cpu

    z=$(ps aux)
    while read -r line
    do
        var_mem=$var_mem$(awk -v var1=$DATA_PREFIX '{print "memory_usage{process=\""var1"_"$11"\", pid=\""$2"\"}", $6line}')
    done <<< "$z"

    pow_val=$(cat /sys/class/power_supply/BAT0/power_now)
    var_pow="power_consumption{system_id=\"$DATA_PREFIX\"} $pow_val"

    cpu_load_str=$(cat /proc/loadavg | awk '{print $1}')/$(nproc)*100
    var_cpu_avg="cpu_usage_avg{system_id=\"$DATA_PREFIX\"} $(echo $cpu_load_str | bc -l)"

    curl -X POST -H  "Content-Type: text/plain" --data "$var_cpu_avg
    " http://localhost:9091/metrics/job/top/instance/machine

    curl -X POST -H  "Content-Type: text/plain" --data "$var_pow
    " http://localhost:9091/metrics/job/top/instance/machine

    curl -X POST -H  "Content-Type: text/plain" --data "$var_cpu
    " http://localhost:9091/metrics/job/top/instance/machine

    curl -X POST -H  "Content-Type: text/plain" --data "$var_mem
    " http://localhost:9091/metrics/job/top/instance/machine

    unset z
    unset var_mem
    unset var_cpu
done